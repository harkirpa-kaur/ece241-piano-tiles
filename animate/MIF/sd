module falling_tile (clk, resetn, x_pixel_location, y_pixel_location, color, write_to_VGA); 
    
    //input ports 
    input wire clk; 
    input wire resetn; 

    //output ports - 640x480 VGA with 9-bit colour depth 
    output reg [9:0] x_pixel_location;
    output reg [8:0] y_pixel_location; 
    output reg [8:0] color; 
    output reg write_to_VGA; 

    //parameters 
    parameter TILE_WIDTH = 160; 
    parameter TILE_HEIGHT = 120; 
    parameter SCREEN_WIDTH = 640; 
    parameter SCREEN_HEIGHT = 480; 
    parameter COLOR_DEPTH = 9; 
    parameter MAX_Y = 360; 

    //since the tile is falling, we need to fix the x location and vary the y location 
    reg [9:0] tile_x = 10'b0; 
    reg [8:0] tile_y = 9'b0; 
    reg [8:0] prev_tile_y = 9'b0;
    //pixel coordinates within the tile 
    reg [7:0] x_tile_px; 
    reg [6:0] y_tile_px; 

    //160x120 = 19200 pixels -> 15 bits to address each pixel 
    wire [14:0] sprite_address; 
    wire [8:0] sprite_color; 
    assign sprite_address = y_tile_px * TILE_WIDTH + x_tile_px; 

    //instantiate the sprite ROM 
    gift #( .COLOR_DEPTH(COLOR_DEPTH), .TILE_W(TILE_WIDTH), .TILE_H(TILE_HEIGHT) ) gift0 ( .clock(clk), .addr(sprite_address), .q(sprite_color) ); 
    
    //falling speed - increment tile y by using a counter 
    reg [23:0] fall_counter; 
    parameter FALL_SPEED = 24'd5000; //adjust this value to change falling speed 

    //code block determines the tile's y position over time 
    always @ (posedge clk ) 
    begin 
        if(!resetn) 
            begin 
                //if reset, then bring tile to the top of the screen and reset the fall 
                tile_y <= 9'd0; 
                fall_counter <= 24'd0; 
                prev_tile_y <= 9'd0;
            end 
        else 
            begin 
                if(fall_counter == FALL_SPEED) 
                    begin 
                    //reset the fall counter + old position
                    fall_counter <= 24'd0; 
                    prev_tile_y <= tile_y;
                    
                    //check if tile has reached the bottom 
                    if(tile_y < MAX_Y) 
                        tile_y <= tile_y + 1'b1; //move tile down by 1 pixel 
                    else 
                        tile_y <= 9'd0; //reset tile to top 
                    end 
                else 
                fall_counter <= fall_counter + 1'b1; //increment fall counter 
            end 
    end 
    //drawing tile to the VGA 
    always @ (posedge clk or negedge resetn) 
    begin 
        if(!resetn) 
            begin 
            //reset everything 
            x_tile_px <= 8'd0; 
            y_tile_px <= 7'd0; 
            x_pixel_location <= 10'd0; 
            y_pixel_location <= 9'd0; 
            color <= 9'b0; 
            write_to_VGA <= 1'b0; 
            end 
        else 
            begin 
            //set the pixel location and color to be drawn 
            x_pixel_location <= tile_x + x_tile_px; 
            y_pixel_location <= tile_y + y_tile_px; 
            color <= sprite_color; 
            write_to_VGA <= 1'b1; 

            //cycle through all pixels in the tile 
            if(x_tile_px == TILE_WIDTH - 1) 
                begin x_tile_px <= 8'd0; 
                if(y_tile_px == TILE_HEIGHT - 1) 
                    y_tile_px <= 7'd0; 
                else 
                    y_tile_px <= y_tile_px + 1'b1; 
                end 
            else x_tile_px <= x_tile_px + 1'b1; 
            end 
    end
endmodule